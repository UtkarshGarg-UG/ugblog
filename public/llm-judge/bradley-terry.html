<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bradley-Terry Model Explorer</title>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<style>
  :root {
    --bg: #ffffff;
    --fg: #111827;
    --muted: #6b7280;
    --ring: #e5e7eb;
    --accent: #3b82f6;
    --accent-soft: #93c5fd;
  }
  html, body {
    background: var(--bg);
    color: var(--fg);
    margin: 0;
    padding: 0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
  }
  .wrap {
    display: grid;
    gap: 16px;
    padding: 16px;
    box-sizing: border-box;
    max-width: 1200px;
    margin: 0 auto;
  }
  .title {
    font-size: 18px;
    font-weight: 600;
    margin: 0;
  }
  .subtitle {
    font-size: 13px;
    color: var(--muted);
    margin: 4px 0 0 0;
  }
  .controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    padding: 12px;
    border: 1px solid var(--ring);
    border-radius: 12px;
    background: #f9fafb;
  }
  .field {
    display: grid;
    gap: 6px;
  }
  .field label {
    font-size: 12px;
    font-weight: 500;
    color: var(--muted);
  }
  input[type="range"] {
    width: 100%;
  }
  input[type="number"] {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid var(--ring);
    border-radius: 8px;
    font-size: 14px;
  }
  .value-display {
    font-size: 14px;
    font-weight: 500;
    color: var(--fg);
  }
  .buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  button {
    padding: 8px 16px;
    border: 1px solid var(--ring);
    background: #fff;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
  }
  button:hover {
    background: #f9fafb;
  }
  button:active {
    transform: translateY(1px);
  }
  button.primary {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }
  button.primary:hover {
    background: #2563eb;
  }
  .charts {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  .chart-container {
    border: 1px solid var(--ring);
    border-radius: 12px;
    padding: 12px;
  }
  .chart {
    width: 100%;
    height: 400px;
  }
  .info-panel {
    border: 1px solid var(--ring);
    border-radius: 12px;
    padding: 16px;
    display: grid;
    gap: 12px;
  }
  .info-row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 8px;
    align-items: center;
    padding: 8px;
    background: #f9fafb;
    border-radius: 8px;
  }
  .info-label {
    font-size: 13px;
    font-weight: 500;
  }
  .info-value {
    font-family: ui-monospace, monospace;
    font-size: 14px;
    color: var(--accent);
  }
  .matrix-container {
    border: 1px solid var(--ring);
    border-radius: 12px;
    padding: 16px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  th, td {
    padding: 8px;
    text-align: center;
    border: 1px solid var(--ring);
  }
  th {
    background: #f9fafb;
    font-weight: 600;
  }
  .win {
    color: #10b981;
    font-weight: 500;
  }
  .loss {
    color: #ef4444;
    font-weight: 500;
  }
  @media (max-width: 900px) {
    .charts {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>
<div class="wrap">
  <div>
    <h1 class="title">Bradley-Terry Model Explorer</h1>
    <p class="subtitle">Adjust pairwise win rates between systems and watch how Bradley-Terry estimates their relative strengths</p>
  </div>

  <div class="controls">
    <div class="field">
      <label>System A vs B (A wins)</label>
      <input id="winsAB" type="range" min="0" max="100" value="65" />
      <div class="value-display"><span id="winsABVal">65</span>%</div>
    </div>
    <div class="field">
      <label>System A vs C (A wins)</label>
      <input id="winsAC" type="range" min="0" max="100" value="55" />
      <div class="value-display"><span id="winsACVal">55</span>%</div>
    </div>
    <div class="field">
      <label>System B vs C (B wins)</label>
      <input id="winsBC" type="range" min="0" max="100" value="70" />
      <div class="value-display"><span id="winsBCVal">70</span>%</div>
    </div>
    <div class="field">
      <label>Total Comparisons</label>
      <input id="totalN" type="number" min="10" max="500" value="100" />
      <div class="value-display"><span id="totalNVal">100</span> per pair</div>
    </div>
  </div>

  <div class="buttons">
    <button id="runBtn" class="primary">Run Algorithm</button>
    <button id="stepBtn">Step Forward</button>
    <button id="resetBtn">Reset</button>
  </div>

  <div class="matrix-container">
    <h3 style="margin: 0 0 12px 0; font-size: 15px;">Pairwise Comparison Matrix</h3>
    <table id="matrixTable">
      <thead>
        <tr>
          <th></th>
          <th>System A</th>
          <th>System B</th>
          <th>System C</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th>System A</th>
          <td>—</td>
          <td id="cellAB">—</td>
          <td id="cellAC">—</td>
        </tr>
        <tr>
          <th>System B</th>
          <td id="cellBA">—</td>
          <td>—</td>
          <td id="cellBC">—</td>
        </tr>
        <tr>
          <th>System C</th>
          <td id="cellCA">—</td>
          <td id="cellCB">—</td>
          <td>—</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="charts">
    <div class="chart-container">
      <h3 style="margin: 0 0 12px 0; font-size: 15px;">Strength Convergence</h3>
      <div id="convergenceChart" class="chart"></div>
    </div>
    <div class="chart-container">
      <h3 style="margin: 0 0 12px 0; font-size: 15px;">Final Rankings</h3>
      <div id="rankingChart" class="chart"></div>
    </div>
  </div>

  <div class="info-panel">
    <h3 style="margin: 0; font-size: 15px;">Current Iteration: <span id="iterDisplay">0</span></h3>
    <div class="info-row">
      <span class="info-label">System A Strength (πₐ)</span>
      <span class="info-value" id="piA">1.000</span>
    </div>
    <div class="info-row">
      <span class="info-label">System B Strength (πᵦ)</span>
      <span class="info-value" id="piB">1.000</span>
    </div>
    <div class="info-row">
      <span class="info-label">System C Strength (πᴄ)</span>
      <span class="info-value" id="piC">1.000</span>
    </div>
    <div class="info-row">
      <span class="info-label">Predicted P(A > B)</span>
      <span class="info-value" id="predAB">—</span>
    </div>
    <div class="info-row">
      <span class="info-label">Predicted P(A > C)</span>
      <span class="info-value" id="predAC">—</span>
    </div>
    <div class="info-row">
      <span class="info-label">Predicted P(B > C)</span>
      <span class="info-value" id="predBC">—</span>
    </div>
  </div>
</div>

<script>
(function() {
  // Elements
  const winsAB = document.getElementById('winsAB');
  const winsAC = document.getElementById('winsAC');
  const winsBC = document.getElementById('winsBC');
  const totalN = document.getElementById('totalN');
  const winsABVal = document.getElementById('winsABVal');
  const winsACVal = document.getElementById('winsACVal');
  const winsBCVal = document.getElementById('winsBCVal');
  const totalNVal = document.getElementById('totalNVal');

  const runBtn = document.getElementById('runBtn');
  const stepBtn = document.getElementById('stepBtn');
  const resetBtn = document.getElementById('resetBtn');

  const cellAB = document.getElementById('cellAB');
  const cellAC = document.getElementById('cellAC');
  const cellBA = document.getElementById('cellBA');
  const cellBC = document.getElementById('cellBC');
  const cellCA = document.getElementById('cellCA');
  const cellCB = document.getElementById('cellCB');

  const iterDisplay = document.getElementById('iterDisplay');
  const piA = document.getElementById('piA');
  const piB = document.getElementById('piB');
  const piC = document.getElementById('piC');
  const predAB = document.getElementById('predAB');
  const predAC = document.getElementById('predAC');
  const predBC = document.getElementById('predBC');

  const convergenceChart = document.getElementById('convergenceChart');
  const rankingChart = document.getElementById('rankingChart');

  // State
  let comparisons = { AB: 65, AC: 55, BC: 70 };
  let n = 100;
  let strengths = { A: 1.0, B: 1.0, C: 1.0 };
  let history = [];
  let currentIter = 0;
  let maxIter = 50;

  // Update display values
  function updateDisplays() {
    winsABVal.textContent = winsAB.value;
    winsACVal.textContent = winsAC.value;
    winsBCVal.textContent = winsBC.value;
    totalNVal.textContent = totalN.value;

    comparisons = {
      AB: parseInt(winsAB.value),
      AC: parseInt(winsAC.value),
      BC: parseInt(winsBC.value)
    };
    n = parseInt(totalN.value);

    updateMatrix();
  }

  function updateMatrix() {
    const wAB = comparisons.AB;
    const wAC = comparisons.AC;
    const wBC = comparisons.BC;

    cellAB.innerHTML = `<span class="win">${wAB}</span> - <span class="loss">${n - wAB}</span>`;
    cellAC.innerHTML = `<span class="win">${wAC}</span> - <span class="loss">${n - wAC}</span>`;
    cellBA.innerHTML = `<span class="win">${n - wAB}</span> - <span class="loss">${wAB}</span>`;
    cellBC.innerHTML = `<span class="win">${wBC}</span> - <span class="loss">${n - wBC}</span>`;
    cellCA.innerHTML = `<span class="win">${n - wAC}</span> - <span class="loss">${wAC}</span>`;
    cellCB.innerHTML = `<span class="win">${n - wBC}</span> - <span class="loss">${wBC}</span>`;
  }

  // Bradley-Terry iteration using MM algorithm
  function btIteration(pi, comparisons, n) {
    const { AB, AC, BC } = comparisons;
    const { A, B, C } = pi;

    // Wins for each system
    const wA = AB + AC;
    const wB = (n - AB) + BC;
    const wC = (n - AC) + (n - BC);

    // Denominator sums
    const denomA = n / (A + B) + n / (A + C);
    const denomB = n / (A + B) + n / (B + C);
    const denomC = n / (A + C) + n / (B + C);

    // Update (MM algorithm)
    let newA = wA / denomA;
    let newB = wB / denomB;
    let newC = wC / denomC;

    // Normalize so they sum to 3 (for 3 systems)
    const sum = newA + newB + newC;
    newA = (newA / sum) * 3;
    newB = (newB / sum) * 3;
    newC = (newC / sum) * 3;

    return { A: newA, B: newB, C: newC };
  }

  function predict(piI, piJ) {
    return piI / (piI + piJ);
  }

  function updateInfo() {
    iterDisplay.textContent = currentIter;
    piA.textContent = strengths.A.toFixed(3);
    piB.textContent = strengths.B.toFixed(3);
    piC.textContent = strengths.C.toFixed(3);

    if (currentIter > 0) {
      const pAB = predict(strengths.A, strengths.B);
      const pAC = predict(strengths.A, strengths.C);
      const pBC = predict(strengths.B, strengths.C);

      const actualAB = comparisons.AB / n;
      const actualAC = comparisons.AC / n;
      const actualBC = comparisons.BC / n;

      predAB.textContent = `${(pAB * 100).toFixed(1)}% (actual: ${(actualAB * 100).toFixed(1)}%)`;
      predAC.textContent = `${(pAC * 100).toFixed(1)}% (actual: ${(actualAC * 100).toFixed(1)}%)`;
      predBC.textContent = `${(pBC * 100).toFixed(1)}% (actual: ${(actualBC * 100).toFixed(1)}%)`;
    } else {
      predAB.textContent = '—';
      predAC.textContent = '—';
      predBC.textContent = '—';
    }
  }

  function reset() {
    strengths = { A: 1.0, B: 1.0, C: 1.0 };
    history = [{ ...strengths }];
    currentIter = 0;
    updateInfo();
    updateCharts();
  }

  function step() {
    if (currentIter >= maxIter) return;
    strengths = btIteration(strengths, comparisons, n);
    history.push({ ...strengths });
    currentIter++;
    updateInfo();
    updateCharts();
  }

  async function run() {
    reset();
    for (let i = 0; i < maxIter; i++) {
      await new Promise(resolve => setTimeout(resolve, 100));
      step();
    }
  }

  async function initCharts() {
    // Convergence chart
    const convTrace1 = {
      x: [0], y: [1],
      mode: 'lines+markers',
      name: 'System A (πₐ)',
      line: { color: '#ef4444' }
    };
    const convTrace2 = {
      x: [0], y: [1],
      mode: 'lines+markers',
      name: 'System B (πᵦ)',
      line: { color: '#3b82f6' }
    };
    const convTrace3 = {
      x: [0], y: [1],
      mode: 'lines+markers',
      name: 'System C (πᴄ)',
      line: { color: '#10b981' }
    };

    const convLayout = {
      height: 400,
      margin: { l: 50, r: 20, t: 20, b: 40 },
      xaxis: { title: 'Iteration', range: [0, maxIter] },
      yaxis: { title: 'Strength (π)', range: [0, 3] },
      showlegend: true,
      legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: -0.2 }
    };

    await Plotly.newPlot(convergenceChart, [convTrace1, convTrace2, convTrace3], convLayout, {
      displayModeBar: false, responsive: true
    });

    // Ranking chart
    const rankTrace = {
      x: ['System A', 'System B', 'System C'],
      y: [1.0, 1.0, 1.0],
      type: 'bar',
      marker: { color: ['#ef4444', '#3b82f6', '#10b981'] },
      text: ['1.000', '1.000', '1.000'],
      textposition: 'outside'
    };

    const rankLayout = {
      height: 400,
      margin: { l: 50, r: 20, t: 20, b: 60 },
      yaxis: { title: 'Strength (π)', range: [0, 2.5] },
      showlegend: false
    };

    await Plotly.newPlot(rankingChart, [rankTrace], rankLayout, {
      displayModeBar: false, responsive: true
    });
  }

  function updateCharts() {
    // Convergence chart
    const iters = history.map((_, i) => i);
    const piAs = history.map(h => h.A);
    const piBs = history.map(h => h.B);
    const piCs = history.map(h => h.C);

    Plotly.restyle(convergenceChart, {
      x: [iters, iters, iters],
      y: [piAs, piBs, piCs]
    }, [0, 1, 2]);

    // Ranking chart
    const latest = history[history.length - 1] || { A: 1, B: 1, C: 1 };
    Plotly.restyle(rankingChart, {
      y: [[latest.A, latest.B, latest.C]],
      text: [[latest.A.toFixed(3), latest.B.toFixed(3), latest.C.toFixed(3)]]
    }, [0]);
  }

  // Event listeners
  winsAB.addEventListener('input', updateDisplays);
  winsAC.addEventListener('input', updateDisplays);
  winsBC.addEventListener('input', updateDisplays);
  totalN.addEventListener('input', updateDisplays);

  runBtn.addEventListener('click', run);
  stepBtn.addEventListener('click', step);
  resetBtn.addEventListener('click', reset);

  // Initialize
  updateDisplays();
  initCharts().then(() => {
    reset();
  });
})();
</script>
</body>
</html>
